<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Browser - Live Preview</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0a; color: #e0e0e0; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; }
  #toolbar { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: #1a1a1a; border-bottom: 1px solid #333; flex-shrink: 0; }
  #toolbar input { flex: 1; padding: 6px 12px; background: #0a0a0a; border: 1px solid #444; border-radius: 6px; color: #e0e0e0; font-size: 13px; }
  #toolbar .status { width: 10px; height: 10px; border-radius: 50%; background: #555; flex-shrink: 0; }
  #toolbar .status.connected { background: #22c55e; }
  #toolbar .status.error { background: #ef4444; }
  #toolbar label { font-size: 12px; color: #888; white-space: nowrap; }
  #viewport-wrap { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
  #viewport { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: auto; cursor: crosshair; }
  #viewport.no-input { cursor: default; pointer-events: none; }
  #info { padding: 4px 16px; background: #1a1a1a; border-top: 1px solid #333; font-size: 11px; color: #666; display: flex; gap: 16px; flex-shrink: 0; }
  #overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 14px; }
</style>
</head>
<body>

<div id="toolbar">
  <div class="status" id="status-dot"></div>
  <input id="ws-url" type="text" placeholder="ws://127.0.0.1:PORT" />
  <button onclick="toggleConnection()" id="connect-btn" style="padding:4px 12px;background:#333;border:1px solid #555;color:#e0e0e0;border-radius:4px;cursor:pointer;">Connect</button>
  <label><input type="checkbox" id="enable-input" checked> Input</label>
</div>

<div id="viewport-wrap">
  <img id="viewport" class="no-input" />
  <div id="overlay">Enter WebSocket URL and click Connect</div>
</div>

<div id="info">
  <span id="info-resolution">--</span>
  <span id="info-fps">--</span>
  <span id="info-latency">--</span>
</div>

<script>
let ws = null;
let frameCount = 0;
let fpsInterval = null;
let lastFrameTime = 0;
const img = document.getElementById('viewport');
const overlay = document.getElementById('overlay');
const dot = document.getElementById('status-dot');
const wsInput = document.getElementById('ws-url');

// Auto-detect port from URL params
const params = new URLSearchParams(location.search);
if (params.get('port')) wsInput.value = `ws://127.0.0.1:${params.get('port')}`;

function toggleConnection() {
  if (ws && ws.readyState <= 1) { ws.close(); return; }
  const url = wsInput.value.trim();
  if (!url) return;
  connect(url);
}

function connect(url) {
  dot.className = 'status';
  overlay.textContent = 'Connecting...';
  ws = new WebSocket(url);
  ws.binaryType = 'arraybuffer';

  ws.onopen = () => {
    dot.className = 'status connected';
    overlay.style.display = 'none';
    document.getElementById('connect-btn').textContent = 'Disconnect';
    frameCount = 0;
    fpsInterval = setInterval(() => {
      document.getElementById('info-fps').textContent = `${frameCount} fps`;
      frameCount = 0;
    }, 1000);
  };

  ws.onmessage = (e) => {
    try {
      const msg = typeof e.data === 'string' ? JSON.parse(e.data) : null;
      if (msg && msg.type === 'frame') {
        img.src = `data:image/jpeg;base64,${msg.data}`;
        frameCount++;
        const now = performance.now();
        if (lastFrameTime) {
          document.getElementById('info-latency').textContent = `${Math.round(now - lastFrameTime)}ms frame delta`;
        }
        lastFrameTime = now;
        if (msg.viewport) {
          document.getElementById('info-resolution').textContent = `${msg.viewport.width}x${msg.viewport.height}`;
        }
        updateInputMode();
      } else if (msg && msg.type === 'status') {
        if (msg.viewport) {
          document.getElementById('info-resolution').textContent = `${msg.viewport.width}x${msg.viewport.height}`;
        }
      }
    } catch (_) {}
  };

  ws.onerror = () => { dot.className = 'status error'; };
  ws.onclose = () => {
    dot.className = 'status';
    overlay.style.display = '';
    overlay.textContent = 'Disconnected';
    document.getElementById('connect-btn').textContent = 'Connect';
    clearInterval(fpsInterval);
  };
}

function updateInputMode() {
  const enabled = document.getElementById('enable-input').checked;
  img.className = enabled ? '' : 'no-input';
}
document.getElementById('enable-input').addEventListener('change', updateInputMode);

// Input injection
function getRelativeCoords(e) {
  const rect = img.getBoundingClientRect();
  const scaleX = img.naturalWidth / rect.width;
  const scaleY = img.naturalHeight / rect.height;
  return { x: Math.round((e.clientX - rect.left) * scaleX), y: Math.round((e.clientY - rect.top) * scaleY) };
}

function sendInput(msg) {
  if (!ws || ws.readyState !== 1 || !document.getElementById('enable-input').checked) return;
  ws.send(JSON.stringify(msg));
}

img.addEventListener('mousedown', (e) => {
  const c = getRelativeCoords(e);
  sendInput({ type: 'input_mouse', action: 'mousedown', x: c.x, y: c.y, button: ['left','middle','right'][e.button] || 'left' });
});
img.addEventListener('mouseup', (e) => {
  const c = getRelativeCoords(e);
  sendInput({ type: 'input_mouse', action: 'mouseup', x: c.x, y: c.y, button: ['left','middle','right'][e.button] || 'left' });
});
img.addEventListener('mousemove', (e) => {
  const c = getRelativeCoords(e);
  sendInput({ type: 'input_mouse', action: 'mousemove', x: c.x, y: c.y });
});
img.addEventListener('wheel', (e) => {
  const c = getRelativeCoords(e);
  sendInput({ type: 'input_mouse', action: 'wheel', x: c.x, y: c.y, deltaX: e.deltaX, deltaY: e.deltaY });
  e.preventDefault();
}, { passive: false });

document.addEventListener('keydown', (e) => {
  if (e.target === wsInput) return;
  sendInput({ type: 'input_keyboard', action: 'keydown', key: e.key, code: e.code, modifiers: { shift: e.shiftKey, ctrl: e.ctrlKey, alt: e.altKey, meta: e.metaKey } });
  if (e.key.length === 1 || ['Backspace','Tab','Enter','Escape'].includes(e.key)) e.preventDefault();
});
document.addEventListener('keyup', (e) => {
  if (e.target === wsInput) return;
  sendInput({ type: 'input_keyboard', action: 'keyup', key: e.key, code: e.code });
});

// Context menu prevention for right-click
img.addEventListener('contextmenu', (e) => e.preventDefault());
</script>
</body>
</html>
